YUI.add("moodle-atto_stash-button",function(e,t){var n="atto_stash",r={SOURCE:"atto_stash_source",ITEMS:"atto_stash_items",TRADES:"atto_stash_trades"},i={SOURCE:"."+r.SOURCE},s={ROOT:'<form class="mform atto_form atto_media" id="{{elementid}}_atto_media_form"><ul class="root nav nav-tabs" role="tablist"><li data-stash-type="{{CSS.ITEMS}}" class="nav-item"><a class="nav-link active" href="#{{elementid}}_{{CSS.ITEMS}}" role="tab" data-toggle="tab">{{get_string "items" component}}</a></li><li data-stash-type="{{CSS.TRADES}}" class="nav-item"><a class="nav-link" href="#{{elementid}}_{{CSS.TRADES}}" role="tab" data-toggle="tab">{{get_string "trades" component}}</a></li></ul><div class="root tab-content"><div data-stash-type="{{CSS.ITEMS}}" class="tab-pane active" id="{{elementid}}_{{CSS.ITEMS}}"><div>Content for items</div></div><div data-stash-type="{{CSS.TRADES}}" class="tab-pane" id="{{elementid}}_{{CSS.TRADES}}"><div>Content for trades</div></div></div><div class="mdl-align"><br/><button class="submit" type="submit">{{get_string "addsnippet" component}}</button></div></form>',TAB_PANES:{ITEMS:'{{renderPartial "form_components.source" context=this id=CSS.LINK_SOURCE}}<label>Enter name<input class="fullwidth {{CSS.NAME_INPUT}}" type="text" id="{{elementid}}_link_nameentry"size="32" required="true"/></label>',TRADES:'{{renderPartial "form_components.source" context=this id=CSS.MEDIA_SOURCE entersourcelabel="videosourcelabel" addcomponentlabel="addsource" multisource="true" addsourcehelp=helpStrings.addsource}}<fieldset class="collapsible collapsed" id="{{elementid}}_video-display-options"><input name="mform_isexpanded_{{elementid}}_video-display-options" type="hidden"><legend class="ftoggler">{{get_string "displayoptions" component}}</legend><div class="fcontainer">{{> form_components.display_options}}</div></fieldset><fieldset class="collapsible collapsed" id="{{elementid}}_video-advanced-settings"><input name="mform_isexpanded_{{elementid}}_video-advanced-settings" type="hidden"><legend class="ftoggler">{{get_string "advancedsettings" component}}</legend><div class="fcontainer">{{> form_components.advanced_settings}}</div></fieldset><fieldset class="collapsible collapsed" id="{{elementid}}_video-tracks"><input name="mform_isexpanded_{{elementid}}_video-tracks" type="hidden"><legend class="ftoggler">{{get_string "tracks" component}} {{{helpStrings.tracks}}}</legend><div class="fcontainer">{{renderPartial "form_components.track_tabs" context=this id=CSS.VIDEO}}</div></fieldset>'}};e.namespace("M.atto_stash").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(){window.console.log("random text"),window.console.log(this.get("viewbutton")),window.console.log(this.get("testparam")),window.console.log(this.get("contextid"));if(!this.get("viewbutton"))return;this._getStashElements(this.get("courseid")),this.addButton({icon:"e/stash_insert",iconComponent:n,callback:this._displayDialogue,tags:"stash",tagMatchRequiresAll:!1})},_getContext:function(){return{elementid:this.get("host").get("elementid"),component:n,CSS:r}},_handleClick:function(e){var t=e.target,n=this.get("host").getSelectionFromNode(t);this.get("host").getSelection()!==n&&this.get("host").setSelection(n)},_displayDialogue:function(){var e=this.getDialogue({headerContent:M.util.get_string("addstashsnippets",n),focusAfterHide:!0,width:660,focusOnShowSelector:i.URL_INPUT});e.set("bodyContent",this._getDialogueContent(this.get("host").getSelection())).show(),M.form.shortforms({formid:this.get("host").get("elementid")+"_atto_stash_form"})},_getStashElements:function(e){window.console.log(e)},_getDialogueContent:function(t){var n=e.Node.create(e.Handlebars.compile(s.ROOT)(this._getContext()));return n},_attachEvents:function(e,t){return e.delegate("click",function(e){e.preventDefault(),this._addMediaSourceComponent(e.currentTarget)},i.MEDIA_SOURCE+" .addcomponent",this),e.delegate("click",function(e){e.preventDefault(),this._addTrackComponent(e.currentTarget)},i.TRACK+" .addcomponent",this),e.delegate("click",function(e){var t=e.currentTarget;if(t.get("checked")){var n=function(e){return this._getTrackTypeFromTabPane(e.ancestor(".tab-pane"))}.bind(this);t.ancestor(".root.tab-content").all(i.TRACK_DEFAULT_SELECT).each(function(e){e!==t&&n(t)===n(e)&&e.set("checked",!1)})}},i.TRACK_DEFAULT_SELECT,this),e.delegate("click",function(e){var t=e.currentTarget,n=t.ancestor(i.POSTER_SOURCE)&&"image"||t.ancestor(i.TRACK_SOURCE)&&"subtitle"||"media";e.preventDefault(),this.get("host").showFilepicker(n,this._getFilepickerCallback(t,n),this)},".openmediabrowser",this),e.all(".nav-item").on("click",function(e){e.currentTarget.get("parentNode").all(".active").removeClass("active")}),e.one(".submit").on("click",function(e){e.preventDefault();var n=this._getMediaHTML(e.currentTarget.ancestor(".atto_form")),r=this.get("host");this.getDialogue({focusAfterHide:null}).hide(),n&&(r.setSelection(t),r.insertContentAtFocusPoint(n),this.markUpdated())},this),e},_applyMediumProperties:function(t,n){if(!n)return t;var r=function(e,t){e.one(i.TRACK_SOURCE+" "+i.URL_INPUT).set("value",t.src),e.one(i.TRACK_LANG_INPUT).set("value",t.srclang),e.one(i.TRACK_LABEL_INPUT).set("value",t.label),e.one(i.TRACK_DEFAULT_SELECT).set("checked",t.defaultTrack)},s=t.one(".root.tab-content > .tab-pane#"+this.get("host").get("elementid")+"_"+n.type.toLowerCase());s.one(i.MEDIA_SOURCE+" "+i.URL_INPUT).set("value",n.sources[0]),e.Array.each(n.sources.slice(1),function(e){this._addMediaSourceComponent(s.one(i.MEDIA_SOURCE+" .addcomponent"),function(t){t.one(i.URL_INPUT).set("value",e)})},this),e.Object.each(n.tracks,function(t,n){var o=t.length?t:[{src:"",srclang:"",label:"",defaultTrack:!1}],u=i["TRACK_"+n.toUpperCase()+"_PANE"];r(s.one(u+" "+i.TRACK),o[0]),e.Array.each(o.slice(1),function(e){this._addTrackComponent(s.one(u+" "+i.TRACK+" .addcomponent"),function(t){r(t,e)})},this)},this),s.one(i.POSTER_SOURCE+" "+i.URL_INPUT).setAttribute("value",n.poster),s.one
(i.WIDTH_INPUT).set("value",n.width),s.one(i.HEIGHT_INPUT).set("value",n.height),s.one(i.MEDIA_CONTROLS_TOGGLE).set("checked",n.controls),s.one(i.MEDIA_AUTOPLAY_TOGGLE).set("checked",n.autoplay),s.one(i.MEDIA_MUTE_TOGGLE).set("checked",n.muted),s.one(i.MEDIA_LOOP_TOGGLE).set("checked",n.loop);var o=this._getMediumTypeFromTabPane(s);return s.siblings(".active").removeClass("active"),t.all(".root.nav-tabs .nav-item a").removeClass("active"),s.addClass("active"),t.one(i[o.toUpperCase()+"_TAB"]+" a").addClass("active"),t},_getMediumProperties:function(e){var t=function(e,t){return e.getAttribute(t)?!0:!1},n={subtitles:[],captions:[],descriptions:[],chapters:[],metadata:[]};return e.all("track").each(function(e){n[e.getAttribute("kind")].push({src:e.getAttribute("src"),srclang:e.getAttribute("srclang"),label:e.getAttribute("label"),defaultTrack:t(e,"default")})}),{type:e.test("video")?MEDIA_TYPES.VIDEO:MEDIA_TYPES.AUDIO,sources:e.all("source").get("src"),poster:e.getAttribute("poster"),width:e.getAttribute("width"),height:e.getAttribute("height"),autoplay:t(e,"autoplay"),loop:t(e,"loop"),muted:t(e,"muted"),controls:t(e,"controls"),tracks:n}},_addTrackComponent:function(e,t){var n=this._getTrackTypeFromTabPane(e.ancestor(".tab-pane")),r=this._getContext({sourcelabel:n+"sourcelabel",addcomponentlabel:"add"+n+"track"});this._addComponent(e,s.FORM_COMPONENTS.TRACK,i.TRACK,r,t)},_addMediaSourceComponent:function(e,t){var n=this._getMediumTypeFromTabPane(e.ancestor(".tab-pane")),o=this._getContext({multisource:!0,id:r.MEDIA_SOURCE,entersourcelabel:n+"sourcelabel",addcomponentlabel:"addsource",addsourcehelp:this.get("help").addsource});this._addComponent(e,s.FORM_COMPONENTS.SOURCE,i.MEDIA_SOURCE,o,t)},_addComponent:function(t,n,r,i,o){var u=t.ancestor(r),a=e.Node.create(e.Handlebars.compile(n)(i)),f=this._getContext(i);f.label="remove";var l=e.Node.create(e.Handlebars.compile(s.FORM_COMPONENTS.REMOVE_COMPONENT)(f));l.one(".removecomponent").on("click",function(e){e.preventDefault(),u.remove(!0)}),u.insert(a,"after"),t.ancestor().insert(l,"after"),t.ancestor().remove(!0),o&&o.call(this,a)},_getFilepickerCallback:function(e,t){return function(n){if(n.url!==""){var s=e.ancestor(".tab-pane");e.ancestor(i.SOURCE).one(i.URL_INPUT).set("value",n.url),s.get("id")===this.get("host").get("elementid")+"_"+r.LINK&&s.one(i.NAME_INPUT).set("value",n.file);if(t==="subtitle"){var o=n.file.split(".vtt")[0].split("-").slice(-1)[0],u=this.get("langs").available.reduce(function(e,t){return t.code===o?t:e},!1);u&&(e.ancestor(i.TRACK).one(i.TRACK_LABEL_INPUT).set("value",u.lang.substr(0,u.lang.lastIndexOf(" "))),e.ancestor(i.TRACK).one(i.TRACK_LANG_INPUT).set("value",u.code))}}}},_getMediumTypeFromTabPane:function(e){return e.getAttribute("data-medium-type")},_getTrackTypeFromTabPane:function(e){return e.getAttribute("data-track-kind")},_getMediaHTML:function(e){var t=this._getMediumTypeFromTabPane(e.one(".root.tab-content > .tab-pane.active")),n=e.one(i[t.toUpperCase()+"_PANE"]);return this["_getMediaHTML"+t[0].toUpperCase()+t.substr(1)](n)},_getMediaHTMLLink:function(t){var n={url:t.one(i.URL_INPUT).get("value"),name:t.one(i.NAME_INPUT).get("value")||!1};return n.url?e.Handlebars.compile(s.HTML_MEDIA.LINK)(n):""},_getMediaHTMLVideo:function(t){var n=this._getContextForMediaHTML(t);return n.width=t.one(i.WIDTH_INPUT).get("value")||!1,n.height=t.one(i.HEIGHT_INPUT).get("value")||!1,n.poster=t.one(i.POSTER_SOURCE+" "+i.URL_INPUT).get("value")||!1,n.sources.length?e.Handlebars.compile(s.HTML_MEDIA.VIDEO)(n):""},_getMediaHTMLAudio:function(t){var n=this._getContextForMediaHTML(t);return n.sources.length?e.Handlebars.compile(s.HTML_MEDIA.AUDIO)(n):""},_getContextForMediaHTML:function(e){var t=[];return e.all(i.TRACK).each(function(e){t.push({track:e.one(i.TRACK_SOURCE+" "+i.URL_INPUT).get("value"),kind:this._getTrackTypeFromTabPane(e.ancestor(".tab-pane")),label:e.one(i.TRACK_LABEL_INPUT).get("value")||e.one(i.TRACK_LANG_INPUT).get("value"),srclang:e.one(i.TRACK_LANG_INPUT).get("value"),defaultTrack:e.one(i.TRACK_DEFAULT_SELECT).get("checked")?"true":null})},this),{sources:e.all(i.MEDIA_SOURCE+" "+i.URL_INPUT).get("value").filter(function(e){return!!e}).map(function(e){return{source:e}}),description:e.one(i.MEDIA_SOURCE+" "+i.URL_INPUT).get("value")||!1,tracks:t.filter(function(e){return!!e.track}),showControls:e.one(i.MEDIA_CONTROLS_TOGGLE).get("checked"),autoplay:e.one(i.MEDIA_AUTOPLAY_TOGGLE).get("checked"),muted:e.one(i.MEDIA_MUTE_TOGGLE).get("checked"),loop:e.one(i.MEDIA_LOOP_TOGGLE).get("checked")}}},{ATTRS:{viewbutton:{},courseid:{},testparam:{}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
